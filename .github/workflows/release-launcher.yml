name: Build Launcher Executables

on:
  workflow_dispatch:
  push:
    branches: [main]
    tags:
      - "v*"
  release:
    types: [published]

jobs:
  build-posix:
    name: Build POSIX Launcher (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build launcher
        run: make launcher-posix

      - name: Package artifact
        id: package
        run: |
          case "$RUNNER_OS" in
            "macOS") archive_name="rfp-launcher-macos.tar.gz" ;;
            "Linux") archive_name="rfp-launcher-linux.tar.gz" ;;
            *) archive_name="rfp-launcher-posix.tar.gz" ;;
          esac
          stage_dir="dist/posix/rfp-assistant"
          rm -rf "$stage_dir"
          mkdir -p "$stage_dir"
          cp -R dist/posix/rfp-launcher "$stage_dir/"
          items=(
            "backend"
            "frontend"
            "docs"
            "azure"
            "tests"
            "docker-compose.yml"
            ".env_example"
            "backend.Dockerfile"
            "frontend.Dockerfile"
            "Dockerfile"
            "Makefile"
            "pyproject.toml"
            "requirements.txt"
            "requirements_test.txt"
            "package.json"
            "package-lock.json"
            "deploy2.sh"
            "README.md"
            "vite.config.js"
          )
          for item in "${items[@]}"; do
            if [ -e "$item" ]; then
              cp -R "$item" "$stage_dir/"
            fi
          done
          archive_path="dist/posix/$archive_name"
          tar -C dist/posix -czf "$archive_path" rfp-assistant
          echo "archive_name=$archive_name" >> "$GITHUB_OUTPUT"
          echo "archive_path=$archive_path" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: launcher-${{ runner.os }}
          path: ${{ steps.package.outputs.archive_path }}

  build-windows:
    name: Build Windows Launcher
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build launcher
        run: pyinstaller --clean --distpath dist/windows --workpath build/pyinstaller_windows build/launcher_windows.spec

      - name: Package artifact
        id: package
        shell: pwsh
        run: |
          $archiveName = "rfp-launcher-windows.zip"
          $stageDir = "dist/windows/rfp-assistant"
          if (Test-Path $stageDir) { Remove-Item $stageDir -Recurse -Force }
          New-Item -ItemType Directory -Path $stageDir | Out-Null
          Copy-Item -Recurse -Force "dist/windows/rfp-launcher" -Destination $stageDir
          $items = @(
            "backend",
            "frontend",
            "docs",
            "azure",
            "tests",
            "docker-compose.yml",
            ".env_example",
            "backend.Dockerfile",
            "frontend.Dockerfile",
            "Dockerfile",
            "Makefile",
            "pyproject.toml",
            "requirements.txt",
            "requirements_test.txt",
            "package.json",
            "package-lock.json",
            "deploy2.sh",
            "README.md",
            "vite.config.js"
          )
          foreach ($item in $items) {
            if (Test-Path $item) {
              Copy-Item -Recurse -Force $item -Destination $stageDir
            }
          }
          $archivePath = "dist/windows/$archiveName"
          if (Test-Path $archivePath) { Remove-Item $archivePath -Force }
          Compress-Archive -Path $stageDir -DestinationPath $archivePath
          "archive_name=$archiveName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "archive_path=$archivePath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: launcher-Windows
          path: ${{ steps.package.outputs.archive_path }}

  publish:
    name: Publish release artifacts
    needs: [build-posix, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Show downloaded files
        run: ls -R artifacts

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          fail_on_unmatched_files: true

